name: Build NixOS LXC

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Collect build metadata (short SHA + arch)
        id: meta
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          case "${{ runner.arch }}" in
            X64) arch="x86_64-linux" ;;
            ARM64) arch="aarch64-linux" ;;
            *) arch="${{ runner.arch }}" ;;
          esac
          echo "arch=$arch" >> $GITHUB_OUTPUT

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      #
      # Enter your flake's devShell and build inside it
      #
      - name: Build LXC tarball using flake devShell
        run: |
          nix develop --command bash -c "
            nixos-generate \
              --flake .#nixmininet \
              -f proxmox-lxc \
              --out-link result
          "

      - name: Rename output with commit hash + arch
        run: |
          mkdir -p artifacts
          cp result/tarball/*.tar.xz "artifacts/nixmininet-lxc-${{ steps.meta.outputs.arch }}-${{ steps.meta.outputs.sha }}.tar.xz"

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/nixmininet-lxc-${{ steps.meta.outputs.arch }}-${{ steps.meta.outputs.sha }}.tar.xz

      - name: Upload CI artifact
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: actions/upload-artifact@v4
        with:
          name: nixmininet-lxc-${{ steps.meta.outputs.arch }}-${{ steps.meta.outputs.sha }}
          path: artifacts/nixmininet-lxc-${{ steps.meta.outputs.arch }}-${{ steps.meta.outputs.sha }}.tar.xz
